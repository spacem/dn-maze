function skillsim(){$(".jobsprite").each(function(){this.style.backgroundImage="url('"+urls.mainbar+"/"+$TIMESTAMP+"-jobicon_pvp.png')"}),$.getJSON(urls.job,function(e){db=e,dskills.each(function(){this.setAttribute("data-desc","hover"),init_description(this)})}),dskills.each(function(){var e=$(this),t=this.getAttribute("data-skill"),a=Job.Cache[t],l=0==a[0]?"_b":"",s=Job.Sprites[t],i=get_tech_count(t);s[1]*=-50,s[2]*=-50,this.style.background="url('"+urls.mainbar+"/"+$TIMESTAMP+"-skillicon"+s[0]+l+".png') "+s[1]+"px "+s[2]+"px",this.getElementsByClassName("skill-bdr")[0].style.background="url('"+urls.border+"') 100px 0",e.find(".skill-lvl").text([a[0]+i,a[3]].join("/")),e.on("mousedown",skill_adj)}),$(".panel-body").on("contextmenu",prevent_default);for(var e=Job.Levels.length;e>0;e--)$("#level").append(tag("option",null,format(lang.level.option,e)).val(e));$("#level").val(Job.MaxLevel),$("#pvp").click(reverse("#pve",function(){return set_cookie("apply_type",1),Job.ApplyType=1,$dpop.persist&&$dpop.update($dpop.persist[0],$dpop.persist),!0})),$("#pve").click(reverse("#pvp",function(){return set_cookie("apply_type",0),Job.ApplyType=0,$dpop.persist&&$dpop.update($dpop.persist[0],$dpop.persist),!0})),$("#free").click(reverse("#strict",function(){return set_cookie("free",1),Job.Free=!0})),$("#strict").click(reverse("#free",strict_switch));var t=0;$("#s").val("").on("input",function(){++t;var e=t,a=$("#s").val();setTimeout(function(){if(t==e){t=0;var l;try{l=new RegExp(a,"im")}catch(s){return}dskills.each(function(){var e=$(this);if(a.length>2){update_description(this,e);var t=e.data("bs.popover").options,s=t.title.text();if(l.test(s))return void(this.style.opacity=1);s=t.content.clone(),s.find(".hidden").remove(),this.style.opacity=l.test(s.text())?1:.33}else this.style.opacity=1})}},500)}),$("#level").change(function(){var e=num($(this).val());$("#level-btn").text(e<=Job.MaxLevel?lang.level.reset:lang.level.raise)}),$("#level-btn").mousedown(function(){var e=num($("#level").val());dskills.each(function(){var t=$(this),a=this.getAttribute("data-skill"),l=db.Skills[a],s=Job.Cache[a];if(e<=Job.MaxLevel&&(Job.Techs={},s[0]=1==db.Skills[a].Levels[1].LevelLimit?1:0,s[2]=0,techs=0),e!=Job.MaxLevel){for(var i=0,n=l.MaxLevel-l.SPMaxLevel,r=n,o=1;r>0;r--,o++){if(l.Levels[r].LevelLimit<=e){i=r;break}if(!(l.Levels[o].LevelLimit<=e))break;i=o}s[1]=Math.min(i,n)}update_skill_icon(a,t)}),refresh_sp(get_max_sp(e),e<=Job.MaxLevel),e<=Job.MaxLevel&&(Job.TSP=[0,0,0],Job.SkillGroups={},Job.BaseSkills={}),Job.MaxLevel=e,update_progress(),$(this).text(lang.level.reset),history_push()}),$("#techs").click(techniques)}function update_progress(){var e=get_total_sp(),t=get_max_sp(),a=e/t*100;$("#max-progress").text(format(lang.progress.max,t)),$("#progress").css("width",a+"%"),$("#rem-progress").text(format(lang.progress.remaining,t-e)),$("#curr-progress").text(format(lang.progress.curr,e))}function set_opacity(e,t){return t<0||t>1?-1:(e.css("opacity",t),t)}function prevent_default(e){e.preventDefault()}function num(e){return parseInt(e)}function sum(e,t){return e+t}function get_total_sp(){return Job.TSP.reduce(sum)}function get_max_sp(e){return Job.Levels.slice(0,e||Job.MaxLevel).reduce(sum)}function tag(e,t,a){return $(document.createElement(e)).addClass(t).text(a)}function reverse(e,t){return function(){t()!==!1&&($(e).removeClass(ON).addClass(OFF),$(this).addClass(ON),history_push())}}function strict_checker(e){var t=($("#modal"),$("#modal-title")),a=$("#modal-body"),l=!0,s=[];return dskills.each(function(){var e=num(this.getAttribute("data-skill")),t=Job.Cache[e],a=db.Skills[e];if(t[0]>0){if(!check_skill_reqs_state(e,a,s))return void(l=!1);if(!check_skill_groups(e,a,s))return void(l=!1)}}),l&&e?(Job.Free=!1,set_cookie("free",0)):(t.text(lang.strict_title),a.empty().append(s.map(function(e){return tag("p",null,e)}))),l}function strict_switch(){return!!strict_checker(!0)||($("#modal").modal("show"),!1)}function history_push(){var e=[];dskills.each(function(){var t=this.getAttribute("data-skill"),a=Job.Sprites[t][3],l=Job.Cache[t],s=1==db.Skills[t].Levels[1].LevelLimit?1:0,i=[build_chars[l[0]-s]],n=get_tech_count(t);n>0&&(Job.Techs.Crest==t&&i.push("."),Job.Techs.Weapon==t&&i.push("'"),["Necklace","Earring","Ring1","Ring2"].forEach(function(e){Job.Techs[e]==t&&i.push("!")})),i.push(),e[a]=i});for(var t=[],a=0;a<72;a++)void 0===e[a]?t.push("-"):t=t.concat(e[a]);history.pushState(Job,null,"/"+Job.EnglishName+"-"+Job.MaxLevel+"/"+t.join(""))}function refresh_sp(e,t){$(".panel").each(function(a){var l=$(this).find(".panel-heading").find("span"),s=l.text().split("/").map(num),i=Job.SP[a];s[1]=num(e*i),t?s[0]=0:s[0]=Job.TSP[a],l.text(s.join("/"))}),update_progress(),$("#level").val(Job.MaxLevel)}function set_cookie(e,t){var a=new Date;a.setTime(a.getTime()+307584e5),document.cookie=e+"="+t+"; path=/; expires="+a.toUTCString()}function format(e){for(var t=Array.prototype.slice.call(arguments,1),a="",l=e.length,s=0,i=0;i<l;i++){var n=e[i],r=e[i+1];"?"==n?"?"==r?(++i,a+="?"):(a+=void 0===t[s]?"":t[s],s++):a+=n}return a}function skill_adj(e){if(!e.altKey){var t=$(this),a=num(this.getAttribute("data-skill")),l=e.shiftKey||e.ctrlKey,s=[].concat(Job.Cache[a]),i=db.Skills[a],n=get_tech_count(a),r=s[0];0==e.button?s[0]=Math.min(s[1],l?s[1]:s[0]+1):2==e.button&&(s[0]=Math.max(0,l?0:s[0]-1),1==i.Levels[1].LevelLimit&&0==s[0]&&(s[0]=1));var o=t.closest(".panel"),d=o.find(".panel-heading").find("span"),p=d.text().split("/").map(num),c=num(o.data("job")),u=0,f=(Math.max(r,s[0]),r<s[0]),v=get_total_sp(),b=get_max_sp();if(f)for(var h=r+1;h<=s[0];h++){var g=i.Levels[h].SkillPoint;if(p[0]+u+g>p[1]||v+u+g>b){s[0]=h-1;break}u+=g}else for(var h=r;h>s[0];h--){var g=i.Levels[h].SkillPoint;if(u-=g,!Job.Free&&!can_reduce_skill(a,i,h-1,c,Job.TSP[c]+u)){s[0]=h,u+=g;break}}if(!(r==s[0]||s[0]+n>i.MaxLevel)){if(!Job.Free&&s[0]>r){if(!check_skill_reqs(a,i))return;if(!check_skill_groups(a,i))return}if(0==s[0]&&n>0){for(var k in Job.Techs)Job.Techs[k]==a&&delete Job.Techs[k];n=0}if(i.SkillGroup){var m=i.SkillGroup;Job.SkillGroups[m]||(Job.SkillGroups[m]=[]);var _=Job.SkillGroups[m];s[0]&&_.indexOf(a)==-1?_.push(a):s[0]||_.indexOf(a)==-1||(Job.SkillGroups[m]=_.filter(function(e){return e!=a}))}if(i.BaseSkillID){var S=i.BaseSkillID;Job.BaseSkills[S]||(Job.BaseSkills[S]=[]);var J=Job.BaseSkills[S];s[0]&&J.indexOf(a)==-1?J.push(a):s[0]||J.indexOf(a)==-1||(Job.BaseSkills[S]=J.filter(function(e){return e!=a}))}p[0]+=u,s[2]+=u,v+=u,Job.TSP[c]+=u,d.text(p.join("/")),Job.Cache[a]=s,update_skill_icon(a,t,n),update_progress(),$dpop.update(this,t),history_push()}}}function update_skill_icon(e,t,a){void 0===a&&(a=get_tech_count(e));var l=Job.Cache[e],s=t[0],i=s.style.backgroundImage.replace("_b.png",".png");s.style.backgroundImage=l[0]?i:i.replace(".png","_b.png"),t.find(".skill-bdr").removeClass("g").addClass(l[0]?null:"g"),t.find(".skill-lvl").removeClass("g b").text([l[0]+a,l[3]].join("/")).addClass(1==a?"g":2==a?"b":null)}function level_satisfied(e,t){var a=Job.Cache[e];return a[0]>=t}function check_skill_reqs(e,t){if(t.NeedSP)for(var a=0;a<3;a++)if(Job.TSP[a]<t.NeedSP[a])return!1;if(t.ParentSkills)if(1==t.SkillGroup&&Job.SkillGroups[1]&&Job.SkillGroups[1].length){if(!check_ult_reqs())return!1}else for(var l in t.ParentSkills)if(!level_satisfied(l,t.ParentSkills[l]))return!1;var s=Job.BaseSkills[t.BaseSkillID];return!s||s.indexOf(e)!=-1||!s.length}function check_ult_reqs(){var e=!1;return Job.SkillGroups[1]&&Job.SkillGroups[1].forEach(function(t){var a=db.Skills[t],l=!0;for(var s in a.ParentSkills)l&=level_satisfied(s,a.ParentSkills[s]);e|=l}),e}function check_skill_reqs_state(e,t,a){if(t.NeedSP)for(var l=0;l<3;l++)if(Job.TSP[l]<t.NeedSP[l])return a&&a.push(format(lang.warnings.tsp,db.Lookup[t.NameID],Job.Names[l],t.NeedSP[l])),!1;if(1!=t.SkillGroup&&t.ParentSkills)for(var s in t.ParentSkills)if(!level_satisfied(s,t.ParentSkills[s]))return a&&a.push(format(lang.warnings.parent,db.Lookup[t.NameID],db.Lookup[db.Skills[s].NameID],t.ParentSkills[s])),!1;var i=Job.BaseSkills[t.BaseSkillID];return!(i&&i.indexOf(e)!=-1&&i.length>1)||(a&&i.forEach(function(l){l!=e&&a.push(format(lang.warnings.base,db.Lookup[t.NameID],db.Lookup[db.Skills[l].NameID]))}),!1)}function check_skill_groups(e,t,a){if(t.SkillGroup){var l=Job.SkillGroups[t.SkillGroup];if(1==t.SkillGroup&&l&&l.length){if(a&&!check_ult_reqs())return l.forEach(function(e){var t=db.Skills[e];for(var l in t.ParentSkills)if(!level_satisfied(l,t.ParentSkills[l])){var s=format(lang.warnings.parent,db.Lookup[t.NameID],db.Lookup[db.Skills[l].NameID],t.ParentSkills[l]);return void(a.indexOf(s)==-1&&a.push(s))}}),!1}else if(l&&l.length){var s=l.indexOf(e)!=-1;return a&&l.length>1&&s&&l.forEach(function(l){l!=e&&a.push(format(lang.warnings.group,db.Lookup[t.NameID],db.Lookup[db.Skills[l].NameID]))}),1==l.length&&s}}return!0}function can_reduce_skill(e,t,a,l,s){for(var i in db.Skills)if(i!=e){var n=db.Skills[i],r=Job.Cache[i];if(n.NeedSP&&r[0]&&s<n.NeedSP[l])return!1;if(1==t.SkillGroup&&1==n.SkillGroup&&r[0]>0&&!a){Job.SkillGroups[1];for(var o in n.ParentSkills)if(!level_satisfied(o,n.ParentSkills[o]))return!1}else if(n.ParentSkills&&n.ParentSkills[e]&&r[0]&&a<n.ParentSkills[e])return!1}return!0}function init_description(e){$(e).popover({animation:!1,html:!0,trigger:"manual",placement:"auto left",container:$body}).on("mouseenter",$dpop.mouseenter).on("mouseleave",$dpop.mouseleave).on("mousedown",$dpop.mousedown)}function update_description(e,t){var a=e.getAttribute("data-skill"),l=Job.Cache[a],s=db.Skills[a],i=t.data("bs.popover").options;i.title=tag("span",Job.ApplyType?"s":null,format($lang.name[Job.ApplyType],db.Lookup[s.NameID]));var n=i.content?i.content:desc_fields.clone(!0),r=get_tech_count(a),o="";r>0&&(o=" +"+r),n.find(".dlvl").find("span:last").text(Math.max(1,l[0])+o),n.find(".dlimit").find("span:last").text(l[3]),l[2]?n.find(".dtsp").show().removeClass("hidden").find("span:last").text(l[2]):n.find(".dtsp").hide().addClass("hidden"),s.NeedWeaponType?n.find(".dweaps").find("span:last").text(s.NeedWeaponType.map($d.weapon).join(", ")):n.find(".dweaps").remove();var d=$lang.type.passive;switch(s.SkillType){case 0:switch(s.DurationType){case 0:d=$lang.type.instant;break;case 1:d=$lang.type.buff;break;case 2:d=$lang.type.debuff}break;case 3:d=$lang.type.ex}n.find(".dtype").find("span:last").text(d);var p=$lang.element.none;switch(s.Element){case 0:p=$lang.element.fire;break;case 1:p=$lang.element.water;break;case 2:p=$lang.element.light;break;case 3:p=$lang.element.dark}n.find(".dele").find("span:last").text(p);var c,u,f,v,b=l[0]+r;if(c=s.Levels[b],f=c?c.ApplyType[Job.ApplyType]:null,u=s.Levels[b+1],v=u?u.ApplyType[Job.ApplyType]:null,0==b&&(c=u,f=v),u){if(n.find(".dreq").show().removeClass("hidden"),n.find(".dreqlvl").find("span:last").removeClass("r").addClass(Job.MaxLevel<u.LevelLimit?"r":null).text(u.LevelLimit),s.NeedSP?n.find(".dreqtsp").empty().append(s.NeedSP.map($d.sp)):n.find(".dreqtsp").remove(),s.ParentSkills){var h=[];for(var g in s.ParentSkills){var k=s.ParentSkills[g],m=Job.Cache[g];h.push(tag("div",m[0]<k?"r":null,format($lang.req.parent,db.Lookup[db.Skills[g].NameID],k)))}n.find(".dreqskills").empty().append(h)}else n.find(".dreqskills").remove();var _=t.closest(".panel").data("job"),$=get_max_sp(),S=Job.TSP[_],J=get_total_sp();n.find(".dreqsp").find("span:last").text(u.SkillPoint).removeClass("r").addClass(S+u.SkillPoint>$*Job.SP[_]||J+u.SkillPoint>$?"r":null)}else n.find(".dreq").hide().addClass("hidden");var x=f?f.DecreaseSP:v.DecreaseSP;x?n.find(".dmp").removeClass("hidden").show().find("span:last").text(x):n.find(".dmp").hide().addClass("hidden");var y=(f?f.DelayTime:v.DelayTime)/1e3;y?n.find(".dcd").removeClass("hidden").show().find("span:last").text(format($lang.cd,y)):n.find(".dcd").hide().addClass("hidden");var L=f?f.SkillExplanationID:v.SkillExplanationID,C=f?f.SkillExplanationIDParam:v.SkillExplanationIDParam;n.find(".dnowv").html(desc_format(db.Lookup[L],C)),0==b||b==s.MaxLevel?(n.find(".dnext").hide().addClass("hidden"),n.find(".dnextdiv").hide()):(n.find(".dnextdiv").show(),n.find(".dnext").show().removeClass("hidden"),n.find(".dnextv").html(desc_format(db.Lookup[v.SkillExplanationID],v.SkillExplanationIDParam))),i.content=n}function desc_tag(e,t){return tag("div",e).append(tag("span","o",t+": "),tag("span"))}function desc_format(e,t){if(!e)return e;t=t.split(",").map($d.params);for(var a=0;a<t.length;a++)e=e.replace("{"+a+"}",t[a]);for(var l=0,s=0,i="",n=0,a=0;a<e.length-1;a++)switch(e.substr(a,2)){case"#y":case"#p":case"#r":case"#s":case"#v":l-s==1?i+=e.substring(n,a)+'</span><span class="'+e.substr(a+1,1)+'">':(i+=e.substring(n,a)+'<span class="'+e.substr(a+1,1)+'">',l++),n=a+2,++a;break;case"#w":s==l?i+=e.substring(n,a):(i+=e.substring(n,a)+"</span>",s++),n=a+2,++a}return i+=e.substr(n),l!=s&&(i+="</span>"),i.replace(/\\n/g,"<br />")}function techniques(){var e=$("#modal"),t=$("#modal-title"),a=$("#modal-body");t.text("Techniques"),a.empty(),techHTML?(a.html(techHTML),init_techs()):(a.text("Loading data..."),a.load("/api/tech/"+Job.EnglishName,function(e){techHTML=e,init_techs()})),e.modal("show")}function init_techs(){var e=["necklace","earring","ring-1","ring-2","weapon","crest"],t=["Necklace","Earring","Ring1","Ring2","Weapon","Crest"];e.forEach(function(e,a){var l=$("#tech-"+e),s=l.next(),i=Job.Techs[t[a]];i&&(l.val(i).prop("disabled",!0),s.removeClass("btn-default").addClass("btn-danger").text("-1")),s.prop("disabled",!l.val()||!i),l.change(function(){var e=l.val();s.removeClass("btn-default btn-primary").addClass(e?"btn-primary":"btn-default").prop("disabled",!e)}),s.click(function(){var e=Job.Techs[t[a]];s.removeClass("btn-default btn-primary btn-danger"),e?(delete Job.Techs[t[a]],s.text("+1").addClass("btn-primary")):(Job.Techs[t[a]]=e=num(l.val()),s.text("-1").addClass("btn-danger"));var i=$(".skill").filter("[data-skill="+e+"]");update_skill_icon(e,i),$dpop.persist&&$dpop.persist.data("skill")==e&&$dpop.update(i[0],i),l.prop("disabled",!e),tech_disable(Job.Techs),history_push()})}),tech_disable(Job.Techs)}function get_tech_count(e,t){void 0===t&&(t=e,e=Job.Techs);var a=0;for(var l in e)e[l]==t&&a++;return a}function tech_disable(e){var t=["necklace","earring","ring-1","ring-2","weapon"],a=["Necklace","Earring","Ring1","Ring2","Weapon"];$(".modal").find("option:disabled").prop("disabled",!1);for(var l=0;l<a.length;l++){var s=e[a[l]];if(s){var i=[].concat(t);i.splice(l,1),i.forEach(function(l){e[a[t.indexOf(l)]]!=s&&disable_skill_tech($("#tech-"+l),s)});var n=Job.Cache[s],r=db.Skills[s],o=get_tech_count(e,s);n[0]+o>=r.MaxLevel&&e.Crest!=s&&disable_skill_tech($("#tech-crest"),s)}}var s=e.Crest;if(s){var n=Job.Cache[s],r=db.Skills[s],o=get_tech_count(e,s);n[0]+o>=r.MaxLevel&&t.forEach(function(t,l){e[a[l]]!=s&&disable_skill_tech($("#tech-"+t),s)})}t.push("crest"),t.forEach(function(e){var t=$("#tech-"+e);for(var a in db.Skills){var l=Job.Cache[a];l[0]||disable_skill_tech(t,a)}})}function disable_skill_tech(e,t){var a=e.next();e.val()==t&&(e.val(""),a.removeClass("btn-primary btn-danger").addClass("btn-default").prop("disabled",!0).text("+1"));var l=e.find("option[value="+t+"]");l.length&&l.prop("disabled",!0)}var ON="btn-primary",OFF="btn-default",build_chars="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_".split("");window.addEventListener("popstate",function(e){oldJob=e.state||jQuery.extend(!0,{},$Job),oldJob.ApplyType=Job.ApplyType,oldJob.Free=Job.Free,Job=oldJob,dskills.each(function(){var e=$(this),t=this.getAttribute("data-skill");update_skill_icon(t,e)}),refresh_sp(get_max_sp(),!1),$("#level").val(Job.MaxLevel);var t="#pvp",a="#pve";Job.ApplyType&&(t="#pve",a="#pvp"),$(t).removeClass(ON).addClass(OFF),$(a).addClass(ON),t="#free",a="#strict",Job.Free&&(t="#strict",a="#free"),$(t).removeClass(ON).addClass(OFF),$(a).addClass(ON),$dpop.persist&&$dpop.update($dpop.persist[0],$dpop.persist)});var $body=$("body"),$lang=lang.description,$d={params:function(e){return"{"==e[0]?db.Lookup[e.substring(1,e.length-1)]:e},weapon:function(e){return db.Weapons[e]},sp:function(e,t){return e>0?tag("span",Job.TSP[t]<e?"r":null,format($lang.req.tsp,Job.Names[t],e)):null}},$dpop={persist:null,mouseenter:function(){var e=$(this),t=e.data("desc");"hover"!=t||$dpop.persist||(update_description(this,e),e.popover("show"))},mouseleave:function(){var e=$(this),t=e.data("desc");"hover"==t&&e.popover("hide")},mousedown:function(e){if(1==e.button){prevent_default(e);var t=$(this),a=t.data("desc");$dpop.update(this,t),"hover"==a?(t.data("desc","mclick"),$dpop.persist=t):(t.data("desc","hover"),$dpop.persist=null)}},update:function(e,t){$dpop.persist&&$dpop.persist.data("skill")!=t.data("skill")&&($dpop.persist.data("desc","hover").popover("hide"),$dpop.persist=null),t.popover("hide"),update_description(e,t),t.popover("show")}},desc_fields=tag("div").append(desc_tag("dlvl",$lang.fields.lvl),desc_tag("dmp",$lang.fields.mp),desc_tag("dweaps",$lang.fields.weap),desc_tag("dtype",$lang.fields.type),desc_tag("dele",$lang.fields.element),desc_tag("dcd",$lang.fields.cd),desc_tag("dlimit",$lang.fields.limit),desc_tag("dtsp",$lang.fields.tsp),tag("div","divider dreq"),tag("div","dreq o",$lang.req.lvl_up),tag("div","dreq dreqlvl").append(tag("span",null,$lang.req.char_lvl),tag("span")),tag("div","dreq dreqskills"),tag("div","dreq dreqtsp"),tag("div","dreq dreqsp").append(tag("span",null,$lang.req.sp),tag("span")),tag("div","dnow").append(tag("div","dnowf o",$lang.curr),tag("div","dnowv")),tag("div","divider dnextdiv"),tag("div","dnext").append(tag("div","dnextf o",$lang.next),tag("div","dnextv"))),techHTML;